<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<title>webcodecs demo</title>
<style type="text/css">
body, button {
    font: 13px Helvetica, arial, freesans, clean, sans-serif;
}
a:link {
    text-decoration: none;
}
a:visited {
    text-decoration: none;
}
a:hover {
    text-decoration: underline;
}
a:active {
    text-decoration: none;
}
a {
    color: #00a;
}
</style>
<script>
    var raw_b, raw_zct;

async function decode(zctdata){
    document.getElementById("status").innerText = 'Pending';
    const decoder_config = {
        codec: "av01.0.01M.08.1",
        hardwareAcceleration: "no-preference"
    };
    let supported = (await VideoDecoder.isConfigSupported(decoder_config)).supported
    if(!supported){
        document.getElementById("status").innerText = 'Config Not Supported';
        return;
    }

    let success_flag = true;

    const decoder = new VideoDecoder({
        async output(frame) {
            document.getElementById("cvs").getContext("2d").drawImage(frame, 0, 0, frame.displayWidth, frame.displayHeight);
            frame.close();
        },
        error(e) {
            success_flag = false;
        }
    });

    decoder.configure(decoder_config);
    let metaints = new Uint8Array(zctdata, 0, 8);
    let json_len = (metaints[0] << 8) + metaints[1];
    raw_zct = new Uint8Array(zctdata);
    let dk = new Uint8Array(zctdata, 8+json_len, zctdata.byteLength -json_len-8);
    raw_b = new Uint8Array(dk);


    const chunk = new EncodedVideoChunk({
        timestamp: 0,
        type: "key",
        data: dk
    });

    decoder.decode(chunk);

    await decoder.flush();

    decoder.close();
    document.getElementById("status").innerText = (success_flag)?"Success":"Failed";
}

function run_decode(url) {
    var request = new XMLHttpRequest();
    request.open("get", url, true);
    request.responseType = "arraybuffer";
    request.onload = async function(event) {
        decode(request.response);
    };
    request.onerror = function (e) {
        console.log("Error!");
    };
    request.send();
}

</script>
<body>
    <h1>If success, canvas below will be rendered</h1>
    <button onclick="run_decode('sample.zct')">decode sample.hevc</button>
    <canvas id="cvs" width="267px" height="267px"></canvas>
    <div>Status: <span id="status">Pending</span></div>
</body>
</html>
